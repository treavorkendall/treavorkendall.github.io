<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Proportion Overlay Tool</title>
<style>
  :root {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  }

  body {
    margin: 0;
    padding: 24px;
    background: #f5f5f7;
    color: #111827;
    display: flex;
    justify-content: center;
  }

  .app {
    max-width: 1100px;
    width: 100%;
    background: #ffffff;
    border-radius: 16px;
    box-shadow: 0 14px 40px rgba(15, 23, 42, 0.12);
    padding: 20px 24px 24px;
    box-sizing: border-box;
  }

  h1 {
    margin: 0;
    font-size: 1.6rem;
    letter-spacing: 0.03em;
  }

  .subtitle {
    margin: 4px 0 16px;
    font-size: 0.9rem;
    color: #6b7280;
  }

  .layout {
    display: grid;
    grid-template-columns: minmax(260px, 320px) 1fr;
    gap: 20px;
    align-items: flex-start;
  }

  @media (max-width: 900px) {
    .layout {
      grid-template-columns: 1fr;
    }
  }

  .panel {
    background: #f9fafb;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    padding: 12px 14px 14px;
  }

  .panel-title {
    font-size: 0.82rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: #6b7280;
    margin-bottom: 8px;
    font-weight: 600;
  }

  .section {
    margin-bottom: 12px;
    padding-bottom: 10px;
    border-bottom: 1px solid #e5e7eb;
  }

  .section:last-of-type {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
  }

  .row {
    margin-bottom: 6px;
    font-size: 0.9rem;
  }

  .row label {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
  }

  .row input[type="checkbox"] {
    cursor: pointer;
  }

  #upload {
    width: 100%;
    font-size: 0.88rem;
  }

  .hint {
    font-size: 0.78rem;
    color: #9ca3af;
    margin-top: 4px;
  }

  .slider-row {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 0.86rem;
    margin-top: 2px;
  }

  .slider-row input[type="range"] {
    flex: 1;
  }

  button {
    appearance: none;
    border: none;
    border-radius: 999px;
    padding: 6px 12px;
    font-size: 0.82rem;
    font-weight: 500;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: background 0.12s ease, box-shadow 0.12s ease, transform 0.08s ease;
  }

  button.primary {
    background: #2563eb;
    color: #f9fafb;
    box-shadow: 0 2px 6px rgba(37, 99, 235, 0.35);
  }

  button.primary:hover {
    background: #1d4ed8;
    box-shadow: 0 4px 10px rgba(37, 99, 235, 0.45);
    transform: translateY(-1px);
  }

  button.primary:active {
    transform: translateY(0);
    box-shadow: 0 2px 6px rgba(37, 99, 235, 0.35);
  }

  button.secondary {
    background: #e5e7eb;
    color: #374151;
    box-shadow: none;
  }

  button.secondary:hover {
    background: #d1d5db;
  }

  button.small {
    padding: 4px 10px;
    font-size: 0.8rem;
  }

  .status {
    font-size: 0.78rem;
    color: #4b5563;
    margin-top: 4px;
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 6px;
  }

  .status-pill {
    display: inline-flex;
    align-items: center;
    padding: 2px 8px;
    border-radius: 999px;
    font-size: 0.75rem;
  }

  .status-pill.missing {
    background: #fee2e2;
    color: #991b1b;
  }

  .status-pill.pending {
    background: #fef3c7;
    color: #92400e;
  }

  .status-pill.ready {
    background: #ecfdf3;
    color: #166534;
  }

  .canvas-wrapper {
    border-radius: 12px;
    border: 1px solid #d1d5db;
    background: #020617;
    padding: 8px;
    box-sizing: border-box;
    max-height: 75vh;
    overflow: auto;
  }

  canvas {
    background: #020617;
    display: block;
    margin: 0 auto;
    width: auto;
    height: auto;
    max-width: none;
    max-height: none;
    cursor: crosshair;
  }

  .canvas-hint {
    font-size: 0.8rem;
    color: #9ca3af;
    margin-top: 6px;
  }

  .badges {
    margin-top: 6px;
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .badge {
    padding: 2px 8px;
    border-radius: 999px;
    font-size: 0.75rem;
    background: #eef2ff;
    color: #3730a3;
  }
</style>
</head>
<body>

<div class="app">
  <h1>Proportion Overlay Tool</h1>
  <p class="subtitle">
    Upload an image and overlay classic drawing grids, calibrated Loomis guides, Reilly rhythms, and a measuring tool.
  </p>

  <div class="layout">
    <!-- Controls -->
    <div class="panel">

      <!-- Image -->
      <div class="section">
        <div class="panel-title">Image</div>
        <div class="row">
          <input type="file" id="upload" accept="image/*">
        </div>
        <div class="hint">Recommended: straight-on portrait for most accurate calibration.</div>
      </div>

      <!-- Grids -->
      <div class="section">
        <div class="panel-title">Grids</div>

        <div class="row">
          <label><input type="checkbox" id="thirds"> Horizontal thirds</label>
        </div>

        <div class="row">
          <label><input type="checkbox" id="fifths"> Vertical fifths</label>
        </div>

        <div class="row" style="display:flex; align-items:center; gap:8px; margin-top:4px;">
          <button id="calibrateFifthsBtn" class="small secondary">Calibrate fifths (nose width)</button>
        </div>

        <div class="status" id="fifthsStatus">
          Fifths use default full image width.
          <span class="status-pill missing" id="fifthsPill">Not calibrated</span>
        </div>

        <div class="row" style="margin-top:10px;">
          <label><input type="checkbox" id="golden"> Golden ratio (φ) lines</label>
        </div>

        <div class="slider-row">
          <span>Guide opacity</span>
          <input type="range" id="opacity" min="0" max="1" step="0.05" value="0.8">
          <span id="opacityVal">0.80</span>
        </div>
      </div>

      <!-- Head Guides -->
      <div class="section">
        <div class="panel-title">Head Guides</div>

        <div class="row">
          <label><input type="checkbox" id="loomis"> Loomis landmarks</label>
        </div>

        <div class="row">
          <label><input type="checkbox" id="reilly"> Reilly rhythms</label>
        </div>

        <div class="row" style="display:flex; align-items:center; gap:8px;">
          <button id="calibrateBtn" class="small secondary">Calibrate hairline → chin</button>
        </div>

        <div class="status" id="calStatus">
          Loomis/Reilly use approximate full-image head until calibrated.
          <span class="status-pill missing">Not calibrated</span>
        </div>
      </div>

      <!-- Measuring -->
      <div class="section">
        <div class="panel-title">Measuring Tool</div>

        <div class="row">
          <label><input type="checkbox" id="measureMode"> Enable measuring tool</label>
        </div>

        <div class="row">
          <button id="clearMeasures" class="small secondary">Clear measurements</button>
        </div>

        <div class="hint">
          Click-drag to measure. Hold Shift to lock horizontal/vertical.
          Shows length (px) and angle (°).
        </div>
      </div>

      <!-- Export -->
      <div class="section">
        <div class="panel-title">Export</div>
        <div class="row">
          <button id="exportBtn" class="small primary">Export PNG</button>
        </div>
      </div>

      <div class="badges">
        <span class="badge">Loomis Calibration</span>
        <span class="badge">Nose-Based Fifths</span>
        <span class="badge">Reilly Rhythms</span>
        <span class="badge">Measuring Tool</span>
      </div>

    </div>

    <!-- Canvas -->
    <div>
      <div class="canvas-wrapper">
        <canvas id="canvas"></canvas>
      </div>

      <div class="canvas-hint">
        Loomis: Click "Calibrate hairline → chin" then click hairline and chin.<br>
        Fifths: Click "Calibrate fifths (nose width)" then click left & right edges of the nose.<br>
        Measuring: Enable, then click-drag. Hold Shift for horizontal/vertical.
      </div>
    </div>

  </div>
</div>

<script>
// --- Elements ---
const upload = document.getElementById("upload");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const chkThirds = document.getElementById("thirds");
const chkFifths = document.getElementById("fifths");
const chkGolden = document.getElementById("golden");
const chkLoomis = document.getElementById("loomis");
const chkReilly = document.getElementById("reilly");

const opacitySlider = document.getElementById("opacity");
const opacityVal = document.getElementById("opacityVal");
const exportBtn = document.getElementById("exportBtn");

const calibrateBtn = document.getElementById("calibrateBtn");
const calStatus = document.getElementById("calStatus");

const calibrateFifthsBtn = document.getElementById("calibrateFifthsBtn");
const fifthsStatus = document.getElementById("fifthsStatus");
const fifthsPill = document.getElementById("fifthsPill");

const measureModeCheckbox = document.getElementById("measureMode");
const clearMeasuresBtn = document.getElementById("clearMeasures");

let img = new Image();

// Loomis calibration: hairline → chin
let calibrationMode = false;
let hairline = null;
let chin = null;

// Fifths calibration: nose width
let fifthsCalMode = false;
let noseLeft = null;
let noseRight = null;

// Measuring tool
let measureMode = false;
let isMeasuring = false;
let measureStart = null;
let currentMeasure = null;
let measureLines = [];


// --- Status helper functions ---
function setStatus(text, type) {
  const pill = calStatus.querySelector(".status-pill");

  let pillClass = "missing";
  let pillText = "Not calibrated";

  if (type === "pending") {
    pillClass = "pending";
    pillText = "Calibrating...";
  } else if (type === "ready") {
    pillClass = "ready";
    pillText = "Calibrated";
  }

  pill.className = "status-pill " + pillClass;
  pill.textContent = pillText;

  calStatus.childNodes[0].textContent = text + " ";
}

function setFifthsStatus(text, type) {
  let pillClass = "missing";
  let pillText = "Not calibrated";

  if (type === "pending") {
    pillClass = "pending";
    pillText = "Calibrating...";
  } else if (type === "ready") {
    pillClass = "ready";
    pillText = "Calibrated";
  }

  fifthsPill.className = "status-pill " + pillClass;
  fifthsPill.textContent = pillText;
  fifthsStatus.childNodes[0].textContent = text + " ";
}


// --- Loomis head bounds ---
function getHeadBounds() {
  if (hairline && chin) {
    const unit = (chin.y - hairline.y) / 3;
    const top = hairline.y - unit;
    const bottom = hairline.y + 3 * unit;
    const centerX = (hairline.x + chin.x) / 2;
    return { top, bottom, centerX, hairlineY: hairline.y, unit };
  }

  // fallback rough head
  const full = canvas.height;
  const unit = full / 4;
  const hairlineY = unit;
  const top = 0;
  const bottom = hairlineY + 3 * unit;
  const centerX = canvas.width / 2;
  return { top, bottom, centerX, hairlineY, unit };
}


// --- Main Drawing ---
function draw() {
  if (!img.src) {
    ctx.fillStyle = "#020617";
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = "#9ca3af";
    ctx.textAlign = "center";
    ctx.font = "14px system-ui";
    ctx.fillText("Upload an image to begin", canvas.width/2, canvas.height/2);
    return;
  }

  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(img,0,0);

  const op = parseFloat(opacitySlider.value);

  if (chkThirds.checked) drawThirds(op);
  if (chkFifths.checked) drawFifths(op);
  if (chkGolden.checked) drawGolden(op);
  if (chkLoomis.checked) drawLoomis(op);
  if (chkReilly.checked) drawReilly(op);

  // Measurements
  measureLines.forEach(drawMeasureLine);
  if (currentMeasure) drawMeasureLine(currentMeasure);
}


// --- Grids ---
function drawThirds(op) {
  ctx.strokeStyle = `rgba(239,68,68,${op})`;
  ctx.lineWidth = 2;
  const y1 = canvas.height/3;
  const y2 = 2*canvas.height/3;

  ctx.beginPath();
  ctx.moveTo(0,y1); ctx.lineTo(canvas.width,y1);
  ctx.moveTo(0,y2); ctx.lineTo(canvas.width,y2);
  ctx.stroke();
}


function drawFifths(op) {
  ctx.strokeStyle = `rgba(37,99,235,${op})`;
  ctx.lineWidth = 2;

  let xs = [];
  let yTop = 0;
  let yBottom = canvas.height;

  if (noseLeft && noseRight && hairline && chin) {
    const left = Math.min(noseLeft.x, noseRight.x);
    const right = Math.max(noseLeft.x, noseRight.x);
    const w = right - left;

    if (w > 0) {
      const x2 = left;
      const x3 = right;
      const x1 = x2 - w;
      const x0 = x1 - w;
      const x4 = x3 + w;
      const x5 = x4 + w;

      xs = [x1, x2, x3, x4];

      const { hairlineY, unit } = getHeadBounds();
      const brow = hairlineY + unit;
      const chinY = hairlineY + 3 * unit;
      yTop = brow;
      yBottom = chinY;
    }
  }

  if (xs.length === 0) {
    const step = canvas.width/5;
    xs = [step,2*step,3*step,4*step];
  }

  ctx.beginPath();
  xs.forEach(x=>{
    ctx.moveTo(x,yTop);
    ctx.lineTo(x,yBottom);
  });
  ctx.stroke();
}


function drawGolden(op) {
  ctx.strokeStyle = `rgba(245,158,11,${op})`;
  ctx.lineWidth = 2;

  const phi = 0.618;
  const x = canvas.width * phi;
  const y = canvas.height * phi;

  ctx.beginPath();
  ctx.moveTo(0,y); ctx.lineTo(canvas.width,y);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(x,0); ctx.lineTo(x,canvas.height);
  ctx.stroke();
}


// --- Loomis ---
function drawLoomis(op) {
  const {top, bottom, centerX, hairlineY, unit} = getHeadBounds();

  const crown = top;
  const hairline = hairlineY;
  const brow = hairline + unit;
  const nose = hairline + 2*unit;
  const chinY = hairline + 3*unit;

  ctx.strokeStyle = `rgba(16,185,129,${op})`;
  ctx.lineWidth = 2;

  ctx.beginPath();
  [crown, hairline, brow, nose, chinY].forEach(y=>{
    ctx.moveTo(0,y);
    ctx.lineTo(canvas.width,y);
  });
  ctx.stroke();

  // Labels
  ctx.fillStyle = "rgba(15,118,110,0.9)";
  ctx.font = "11px system-ui";
  ctx.textAlign = "left";
  [
    {y:crown, text:"Crown"},
    {y:hairline, text:"Hairline"},
    {y:brow, text:"Brow"},
    {y:nose, text:"Nose"},
    {y:chinY, text:"Chin"}
  ].forEach(l=>{
    ctx.fillText(l.text, centerX+6, l.y-2);
  });
}


// --- Reilly ---
function drawReilly(op) {
  const {top,bottom,centerX,hairlineY,unit} = getHeadBounds();
  const brow = hairlineY + unit;
  const nose = hairlineY + 2*unit;
  const chinY = hairlineY + 3*unit;
  const mouth = (nose + chinY)/2;

  ctx.strokeStyle = `rgba(139,92,246,${op})`;
  ctx.lineWidth = 2;

  const h = bottom-top;
  const cheekX = h * 0.18;

  // Centerline
  ctx.beginPath();
  ctx.moveTo(centerX,top);
  ctx.lineTo(centerX,chinY);
  ctx.stroke();

  // Cheek arcs
  ctx.beginPath();
  ctx.moveTo(centerX-cheekX*0.9, brow);
  ctx.quadraticCurveTo(centerX-cheekX*1.3,(brow+nose)/2,centerX-cheekX*0.9,mouth);

  ctx.moveTo(centerX+cheekX*0.9, brow);
  ctx.quadraticCurveTo(centerX+cheekX*1.3,(brow+nose)/2,centerX+cheekX*0.9,mouth);

  // Jaw arcs
  ctx.moveTo(centerX-cheekX*0.9, mouth);
  ctx.quadraticCurveTo(centerX-cheekX*1.1,(mouth+chinY)/2,centerX-cheekX*0.3,chinY);

  ctx.moveTo(centerX+cheekX*0.9, mouth);
  ctx.quadraticCurveTo(centerX+cheekX*1.1,(mouth+chinY)/2,centerX+cheekX*0.3,chinY);
  ctx.stroke();

  // Brow arc
  ctx.beginPath();
  const templeX = h*0.26;
  ctx.moveTo(centerX-templeX, brow);
  ctx.quadraticCurveTo(centerX, brow-unit*0.6, centerX+templeX, brow);
  ctx.stroke();
}


// --- Measuring ---
function drawMeasureLine(line) {
  const {x1,y1,x2,y2} = line;

  ctx.strokeStyle = "rgba(209,213,219,0.95)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(x1,y1);
  ctx.lineTo(x2,y2);
  ctx.stroke();

  const dx = x2-x1;
  const dy = y2-y1;
  const len = Math.sqrt(dx*dx + dy*dy);

  let angleDeg = Math.atan2(dy,dx)*180/Math.PI;
  if (angleDeg<0) angleDeg+=360;
  if (angleDeg>180) angleDeg=360-angleDeg;

  const label = `len: ${len.toFixed(1)} px • ${angleDeg.toFixed(1)}°`;

  ctx.font = "12px system-ui";
  ctx.textAlign = "left";
  const lx = x2 + 6;
  const ly = y2 - 6;
  const width = ctx.measureText(label).width+8;

  ctx.fillStyle = "rgba(255,255,255,0.9)";
  ctx.fillRect(lx-4, ly-12, width,16);

  ctx.fillStyle = "#111";
  ctx.fillText(label, lx, ly);
}


// --- Upload ---
upload.addEventListener("change", e=>{
  const file = e.target.files[0];
  if (!file) return;

  const url = URL.createObjectURL(file);
  img.onload = ()=>{
    canvas.width = img.width;
    canvas.height = img.height;

    hairline = null;
    chin = null;
    calibrationMode = false;

    noseLeft = null;
    noseRight = null;
    fifthsCalMode = false;

    measureLines = [];
    currentMeasure = null;
    isMeasuring = false;

    setStatus("Loomis/Reilly use approximate full-image head until calibrated.","missing");
    setFifthsStatus("Fifths use default full width.","missing");

    draw();
  };
  img.src = url;
});


// --- Generic control events ---
[chkThirds, chkFifths, chkGolden, chkLoomis, chkReilly].forEach(el=>{
  el.addEventListener("input", draw);
});

opacitySlider.addEventListener("input", ()=>{
  opacityVal.textContent = Number(opacitySlider.value).toFixed(2);
  draw();
});


// --- Export ---
exportBtn.addEventListener("click", ()=>{
  const link = document.createElement("a");
  link.download = "proportions_overlay.png";
  link.href = canvas.toDataURL("image/png");
  link.click();
});


// --- Loomis Calibration (Hairline → Chin) ---
calibrateBtn.addEventListener("click", ()=>{
  if (!img.src) return;
  calibrationMode = true;
  hairline = null; chin=null;
  setStatus("Click the hairline, then the chin.","pending");
});


// --- Fifths Calibration (nose width) ---
calibrateFifthsBtn.addEventListener("click", ()=>{
  if (!img.src) return;
  fifthsCalMode = true;
  noseLeft=null; noseRight=null;
  setFifthsStatus("Click the left edge of the nose.","pending");
});


// --- Canvas clicks for calibration ---
canvas.addEventListener("click", e=>{
  if (!img.src) return;

  const rect = canvas.getBoundingClientRect();
  const x = (e.clientX-rect.left)*(canvas.width/rect.width);
  const y = (e.clientY-rect.top)*(canvas.height/rect.height);

  // Loomis
  if (calibrationMode) {
    if (!hairline) {
      hairline = {x,y};
      setStatus("Now click the chin.","pending");
    } else if (!chin) {
      chin = {x,y};
      calibrationMode=false;
      setStatus("Loomis calibrated.","ready");
    }
    draw();
    return;
  }

  // Fifths
  if (fifthsCalMode) {
    if (!noseLeft) {
      noseLeft={x,y};
      setFifthsStatus("Click the right edge of the nose.","pending");
    } else if (!noseRight) {
      noseRight={x,y};
      fifthsCalMode=false;
      setFifthsStatus("Fifths calibrated from nose width (brow → chin).","ready");
    }
    draw();
    return;
  }
});


// --- Measuring tool ---
measureModeCheckbox.addEventListener("change", e=>{
  measureMode = e.target.checked;
  isMeasuring=false;
  currentMeasure=null;
  draw();
});

clearMeasuresBtn.addEventListener("click", ()=>{
  measureLines=[];
  currentMeasure=null;
  isMeasuring=false;
  draw();
});


canvas.addEventListener("mousedown", e=>{
  if (!measureMode || !img.src) return;

  const rect = canvas.getBoundingClientRect();
  const x = (e.clientX-rect.left)*(canvas.width/rect.width);
  const y = (e.clientY-rect.top)*(canvas.height/rect.height);

  measureStart={x,y};
  currentMeasure={x1:x, y1:y, x2:x, y2:y};
  isMeasuring=true;
  draw();
});

canvas.addEventListener("mousemove", e=>{
  if (!measureMode || !isMeasuring || !img.src) return;

  const rect = canvas.getBoundingClientRect();
  let x = (e.clientX-rect.left)*(canvas.width/rect.width);
  let y = (e.clientY-rect.top)*(canvas.height/rect.height);

  if (e.shiftKey && measureStart) {
    const dx=Math.abs(x-measureStart.x);
    const dy=Math.abs(y-measureStart.y);
    if (dx>dy) y=measureStart.y;
    else x=measureStart.x;
  }

  currentMeasure.x2=x;
  currentMeasure.y2=y;
  draw();
});

canvas.addEventListener("mouseup", e=>{
  if (!measureMode || !isMeasuring || !img.src) return;

  isMeasuring=false;
  measureLines.push({...currentMeasure});
  currentMeasure=null;
  draw();
});


// --- Initial state ---
canvas.width = 800;
canvas.height = 500;
draw();
setStatus("Loomis/Reilly use approximate full-image head until calibrated.","missing");
setFifthsStatus("Fifths use default full width.","missing");

</script>
</body>
</html>
